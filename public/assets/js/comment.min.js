var formId = "comment_form",
    commentNameId = "comment_name",
    commentEmailId = "comment_email",
    commentContentId = "comment_content"
var code;

function openComment(t)
{
    $(t).addClass("hidden"), buildForm(0), loadMcePlugins((function ()
    {
        initMce("comment_content")
    }))
}

function replyComment(t)
{
    buildForm(t), loadMcePlugins((function ()
    {
        initMce("comment_content_" + t);
    }))
}

function buildForm(t)
{
    var elements = document.querySelectorAll("[id*=comment_form]");
    elements.forEach(function(element) {
      element.innerHTML = "";
    });

    var e = formId,
        n = commentNameId,
        o = commentEmailId,
        a = commentContentId;
    t > 0 && (e += "_" + t, n += "_" + t, o += "_" + t, a += "_" + t);
    var i = $("#" + e);
    if ($("#" + n).length) return i.show(), void tinyMCE.get(a).focus();
    var c = $('<div class="comment-info"></div>');
    i.append('<textarea id="' + a + '" class="px-0 w-full text-[16px] border-0 focus:ring-0 focus:outline-none text-white placeholder-zinc-400 bg-zinc-800" placeholder="Nội dung bình luận" />');
    i.append(c);
    var s = "",
        r = "";
    s.length && (s = $("<div />").html(s).text(), $("#" + n).val(s)), r.length && (r = $("<div />").html(r).text(), $("#" + o).val(r))

}

function initMce(t)
{
    tinymce.init({
        forced_root_block: !1,
        force_br_newlines: !0,
        force_p_newlines: !1,
        entity_encoding: "raw",
        selector: "#" + t,
        menubar: !1,
        statusbar: !1,
        plugins: ["autoresize", "emobabysoldier, emoonion, emobafu, emothobua, emothotuzki, emoyoyo, emopanda, emotrollface, emogif", "paste"],
        paste_as_text: !0,
        toolbar: "emotrollface emoonion emobafu emothobua emothotuzki emoyoyo emopanda emobabysoldier emogif",
        setup: function (t)
        {
            t.on("init", (function ()
            {
                this.getDoc().body.style.fontSize = "16px"
            }))
        },
        height: 100,
        autoresize_min_height: 100,
        autoresize_max_height: 300,
        autoresize_bottom_margin: 0,
        init_instance_callback: function ()
        {
            setTimeout((function ()
            {
                tinymce.execCommand("mceFocus", !1, t)
            }), 500)
        }
    })
}

function loadMcePlugins(t)
{
    if ("undefined" == typeof tinymce)
    {
        var e = document.createElement("script");
        e.type = "text/javascript", e.readyState ? e.onreadystatechange = function ()
        {
            "loaded" != e.readyState && "complete" != e.readyState || (e.onreadystatechange = null, t())
        } : e.onload = function ()
        {
            t()
        }, e.src = "/public/assets/js/tinymce.min.js";
        var n = document.getElementById("comments-js");
        n.parentNode.insertBefore(e, n)
    } else t()
}

$('.form-comment').submit(function(e) {
    e.preventDefault();
    let type = $(this).data('type');
    let comment = "";
    let id = null;
    if(type == "comment"){
        comment = tinymce.get('comment_content').getContent();
    }else{
        id = $(this).data('id');
        comment = tinymce.get(`comment_content_${id}`).getContent();
    }
    if(comment == ''){
        alert('Vui lòng nhập bình luận');
    } else {
        $.ajax({
            url: '/comment',
            type: 'POST',
            data: {
                _token: $('meta[name="csrf-token"]').attr("content"),
                content: comment,
                id: id_item,
                chapter_id: chapter_id ? chapter_id : null,
                type: type,
                comment_id: type == "comment" ? null : $(this).data('id'),
                table: table
            },
            success: function(data) {
                if(type == "comment"){
                    tinymce.get('comment_content').setContent('');
                    $('.list-comment').prepend(data.message);
                }else{
                    tinymce.get(`comment_content_${id}`).setContent('');
                    $(`#box-replies-${id}`).prepend(data.message);
                }
            }, error: function() {
                alert('Có lỗi xảy ra');
            }
        });
    }
});
$('.btn-like').click(function() {
    const type = $(this).data('type');
    const id = $(this).data('id');
    $.ajax({
        url: '/like',
        type: 'POST',
        data: {
            _token: $('meta[name="csrf-token"]').attr("content"),
            type: type,
            id: id
        },
        success: function(data) {
            if(type && type == "reply"){
                $(`#reply-like-${id}`).text(data.like);
            }else{
                $(`#comment-like-${id}`).text(data.like);
            }
        }, error: function() {
            alert('Có lỗi xảy ra');
        }
    });
});
$('.btn-dislike').click(function() {
    const type = $(this).data('type');
    const id = $(this).data('id');
    $.ajax({
        url: 'dislike',
        type: 'POST',
        data: {
            _token: $('meta[name="csrf-token"]').attr("content"),
            type: type,
            id: id
        },
        success: function(data) {
            if(type && type == "reply"){
                $(`#reply-dislike-${id}`).text(data.dislike);
            }else{
                $(`#comment-dislike-${id}`).text(data.dislike);
            }
        }, error: function() {
            alert('Có lỗi xảy ra');
        }
    });
});
$('.btn-reply').click(function() {
    const id = $(this).data('id');
    const type = $(this).data('type');
    if(type && type == "reply"){
        $(`#form-reply-${id}`).toggle();
    }else{
        $(`#form-${id}`).toggle();
    }
});

$('.btn-close').click(function() {
    const id = $(this).data('id');
    const type = $(this).data('type');
    if(type && type == "reply"){
        $(`#form-reply-${id}`).toggle();
    }else{
        $(`#form-${id}`).toggle();
    }
});
